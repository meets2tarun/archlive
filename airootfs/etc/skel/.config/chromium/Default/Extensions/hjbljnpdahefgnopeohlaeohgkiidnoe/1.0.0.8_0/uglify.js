function nextTick(e){setTimeout(e,0)}function make4Len16(e){var t=e.toString(16);while(t.length<4){t="0"+t}return t}var pendingFuncs;window.addEventListener("message",function(){if(pendingFuncs){$.each(pendingFuncs,function(e,t){t()});pendingFuncs=null}},false);function unsafeCallback(e){return e}function ab2str(e){if(e.constructor.name=="ArrayBuffer"){e=new Uint8Array(e)}return String.fromCharCode.apply(null,e)}function str2ab(e,t,n){var i=e.length;if(n)i++;if(!t){t=new ArrayBuffer(i)}var r=new Uint8Array(t);if(n)r[e.length]=0;for(var o=0,s=e.length;o<s;o++){r[o]=e.charCodeAt(o)}return t}var slashN="\n".charCodeAt(0);function writeLine(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);writeString(e,t+"\n",n)}function readLine(e,t){var n=[];function i(){e.read(function(r){for(var o=0;o<r.byteLength;o++){if(r[o]==slashN){var s=r.subarray(0,o);n.push(s);var a="";for(var c in n){c=n[c];a+=ab2str(c)}var u=r.subarray(o+1);e.unshift(u);t(a);return}}n.push(r);i()})}i()}function readString(e,t){var n="";e.onClose=function(){t(n)};function i(t){n+=ab2str(t);e.read(i)}e.read(i)}function writeString(e,t,n){if(t.constructor.name=="Object")t=JSON.stringify(t);e.write(str2ab(t),n)}function appendBuffer(e,t){var n=new Uint8Array(e.byteLength+t.byteLength);n.set(e,0);n.set(t,e.byteLength);return n}var timeThing=(new Date).getTime();function timeTrace(e){var t=(new Date).getTime();console.log(e+": "+(t-timeThing));timeThing=t}function bufferToHex(e){var t=new Uint8Array(e);var n="";for(var i in t){i=t[i];if(i<16)n+="0"+i.toString(16);else n+=i.toString(16)}return n}function hexToBuffer(e){var t=new ArrayBuffer(e.length/2);var n=new Uint8Array(t);for(var i=0;i<e.length/2;i++){var r=e.substr(i*2,2);n[i]=parseInt(r,16)}return t}function base64ToArrayBuffer(e){var t=window.atob(e);var n=t.length;var i=new Uint8Array(n);for(var r=0;r<n;r++){var o=t.charCodeAt(r);i[r]=o}return i.buffer}function arrayBufferToBase64(e){var t="";var n=new Uint8Array(e);var i=n.byteLength;for(var r=0;r<i;r++){t+=String.fromCharCode(n[r])}return window.btoa(t)}var b64map="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var b64pad="=";function hex2b64(e){var t;var n;var i="";for(t=0;t+3<=e.length;t+=3){n=parseInt(e.substring(t,t+3),16);i+=b64map.charAt(n>>6)+b64map.charAt(n&63)}if(t+1==e.length){n=parseInt(e.substring(t,t+1),16);i+=b64map.charAt(n<<2)}else if(t+2==e.length){n=parseInt(e.substring(t,t+2),16);i+=b64map.charAt(n>>2)+b64map.charAt((n&3)<<4)}while((i.length&3)>0){i+=b64pad}return i}if(!String.prototype.startsWith){Object.defineProperty(String.prototype,"startsWith",{enumerable:false,configurable:false,writable:false,value:function(e,t){t=t||0;return this.lastIndexOf(e,t)===t}})}function getQueryVariable(e,t){if(!t)t=window.location;var n=t.search.substring(1);var i=n.split("&");for(var r=0;r<i.length;r++){var o=i[r].split("=");if(decodeURIComponent(o[0])==e){return decodeURIComponent(o[1])}}}Object.fromArray=function(e){var t={};for(var n in e){var i=e[n];t[i]=i}return t};$.ajaxTransport("+binary",function(e,t,n){if(window.FormData&&(e.dataType&&e.dataType=="binary"||e.data&&(window.ArrayBuffer&&e.data instanceof ArrayBuffer||window.Blob&&e.data instanceof Blob))){return{send:function(t,n){var i=new XMLHttpRequest,r=e.url,o=e.type,s=e.async||true,a=e.responseType||"blob",c=e.data||null,u=e.username||null,d=e.password||null;i.addEventListener("load",function(){var t={};t[e.dataType]=i.response;n(i.status,i.statusText,t,i.getAllResponseHeaders())});i.open(o,r,s,u,d);for(var f in t){i.setRequestHeader(f,t[f])}i.responseType=a;i.send(c)},abort:function(){n.abort()}}}});function throttleTimeout(e,t,n,i){if(e){clearTimeout(e.timeout)}else{e={items:[]}}e.timeout=setTimeout(function(){i(e.items);e.items=[]},n);e.items.push(t);return e}function copyTextToClipboard(e){var t=document.createElement("textarea");t.style.position="fixed";t.style.top=0;t.style.left=0;t.style.width="2em";t.style.height="2em";t.style.padding=0;t.style.border="none";t.style.outline="none";t.style.boxShadow="none";t.style.background="transparent";t.value=e;document.body.appendChild(t);t.select();try{var n=document.execCommand("copy")}catch(i){console.log("Oops, unable to copy")}document.body.removeChild(t)}function showNotification(e,t){t=t||"/icon.png";console.log("notification:",e);if(!window.chrome||!window.chrome.notifications)return;var n=chrome.runtime.getManifest().name;chrome.notifications.create({type:"basic",iconUrl:t,title:n,message:e})}var blobFromUrl=function(){var e={};return function(t,n){if(e[t]){n(e[t]);return}var i=new XMLHttpRequest;i.open("GET",t,true);i.responseType="blob";i.onload=function(i){n(e[t]=window.URL.createObjectURL(this.response))};i.send()}}();if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.onReceive.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.dataReceived(new Uint8Array(e.data))});chrome.sockets.tcp.onReceiveError.addListener(function(e){var t=Socket.readers[e.socketId];if(t==null)return;t.destroy();t.dataReceived(null)});chrome.sockets.tcpServer.onAccept.addListener(function(e){chrome.sockets.tcp.setPaused(e.clientSocketId,false);var t=Server.listeners[e.socketId];if(t==null)return;t(new Socket({socketId:e.clientSocketId}))})}(function(){function e(t,n){if(t.socketId){this.socketId=t.socketId;e.readers[this.socketId]=this}else if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.create(function(i){this.socketId=i.socketId;chrome.sockets.tcp.connect(this.socketId,t.host,t.port,function(t){if(!t){e.readers[i.socketId]=this;n(this)}else{chrome.runtime.lastError;this.destroy();n(null)}}.bind(this))}.bind(this))}else{var i;if(!t.ns){this.ns=new require("net").Socket();this.ns.connect({port:t.port,host:t.host},function(){i=true;n(this)}.bind(this))}else{this.ns=t.ns;i=true}this.ns.on("close",function(){this.destroy();if(!i)n(null)}.bind(this));this.ns.on("data",function(e){this.dataReceived(e)}.bind(this))}}e.readers={};e.connect=function(t,n){return new e(t,n)};e.pump=function(e,t,n){if(!e||!t){console.error("Socket.pump called with null socket",e,t);n();return}var i=function(){e.read(r)}.bind(e);var r=function(e){var n=e.buffer;if(e.byteOffset||e.length!=n.byteLength){n=n.slice(e.byteOffset,e.byteOffset+e.length)}t.write(n,i)}.bind(t);e.read(r);e.onClose=n};e.stream=function(t,n,i){e.pump(t,n,function(){if(n)n.destroy();if(i){var e=i;i=null;e()}});e.pump(n,t,function(){if(t)t.destroy();if(i){var e=i;i=null;e()}})};e.eat=function(e){function t(){e.read(t)}t()};e.prototype.read=function(){if(this.pendingCallback){throw new Error("double callback")}if(this.closed&&!this.pending){var e=this.onClose;if(e){delete this.onClose;e()}return}var t=0;if(arguments[t].constructor.name=="Number"){this.pendingLength=arguments[t++]}else{this.pendingLength=0}var e=arguments[t];if(!this.pending||this.paused){this.pendingCallback=e;return}if(!this.pendingLength){this.pendingLength=this.buffered()}else if(this.pendingLength>this.buffered()){this.pendingCallback=e;return}var n;var i=0;while(i<this.pendingLength){var r=this.pending.shift();this.bufferedLength-=r.length;if(!this.pending.length)delete this.pending;var o=r;var s=Math.min(o.byteLength,this.pendingLength-i);if(s!=o.byteLength){var a=o.subarray(0,s);var c=o.subarray(s);this.unshift(c);o=a}if(!n&&o.byteLength!=this.pendingLength)n=new Uint8Array(this.pendingLength);if(n){n.set(o,i)}else{n=o}i+=o.byteLength}e(n)};e.prototype.write=function(e,t){if(this.pendingWrite)console.error("write is already in progress!");if(t==null){console.error("write callback is null?");t=function(){}}this.pendingWrite=t;if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.send(this.socketId,e,function(n){chrome.runtime.lastError;if(!n||n.resultCode){delete this.pendingWrite;return}if(n.bytesSent<e.byteLength){this.write(e.slice(n.bytesSent),t)}else{delete this.pendingWrite;t()}}.bind(this))}else{if(!this.ns)return;if(!e.byteLength){require("process").nextTick(function(){delete this.pendingWrite;t()}.bind(this));return}this.ns.write(Buffer.from(e),function(){delete this.pendingWrite;t()}.bind(this))}};e.prototype.destroy=function(e,t){if(window.chrome&&window.chrome.sockets){chrome.sockets.tcp.close(this.socketId,function(){chrome.runtime.lastError})}else{this.dataReceived(null);if(this.ns){this.ns.destroy();delete this.ns}}};e.prototype.unshift=function(e){if(e.byteLength==0)return;if(!this.pending)this.pending=[e];else this.pending.unshift(e);if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length};e.prototype.dataReceived=function(e){if(e){if(e.asUint8Array)e=e.asUint8Array();if(e.constructor==ArrayBuffer)e=new Uint8Array(e)}if(e&&e.length){var t=new Uint8Array(e);if(!this.pending)this.pending=[t];else this.pending.push(t)}if(e==null){this.closed=true}else{if(!this.bufferedLength)this.bufferedLength=0;this.bufferedLength+=e.length}if(this.paused||!this.pending||!this.pending.length){var n=this.onClose;if(this.closed&&n){delete this.onClose;n()}return}var i=this.pendingLength;var n=this.pendingCallback;if(n){delete this.pendingCallback;this.read(i,n)}};e.prototype.buffered=function(){return this.bufferedLength};e.prototype.pause=function(){if(this.paused){return}this.paused=true;this.onPause()};e.prototype.resume=function(){if(!this.paused){return}this.paused=false;this.onResume()};e.prototype.onResume=function(){chrome.sockets.tcp.setPaused(this.socketId,false,function(){})};e.prototype.onPause=function(){chrome.sockets.tcp.setPaused(this.socketId,true,function(){})};function t(){}t.listeners={};t.prototype.__proto__=e.prototype;t.prototype.destroy=function(){if(window.chrome&&window.chrome.sockets){chrome.sockets.tcpServer.close(this.socketId,function(){chrome.runtime.lastError})}else{if(this.ns){this.ns.close();delete this.ns}}};t.prototype.listen=function(n,i,r){var o;var s;if(n.constructor.name=="Number"){o=n;s="0.0.0.0"}else{s=n.address;o=n.port}if(window.chrome&&window.chrome.sockets){chrome.sockets.tcpServer.create(function(e){this.socketId=e.socketId;t.listeners[this.socketId]=i;chrome.sockets.tcpServer.listen(e.socketId,s,o,function(e){chrome.runtime.lastError;if(e){this.destroy();if(r){r(e)}return}chrome.sockets.tcpServer.getInfo(this.socketId,function(t){this.localAddress=t.localAddress;this.localPort=t.localPort;if(r){r(e)}}.bind(this))}.bind(this))}.bind(this))}else{this.ns=require("net").createServer(function(t){i(new e({ns:t}))}.bind(this));this.ns.on("close",function(){this.destroy()}.bind(this));this.ns.on("error",function(e){if(r)r(e)}.bind(this));this.ns.on("listening",function(){var e=this.ns.address();this.localAddress=e.address;this.localPort=e.port;if(r)r()}.bind(this));this.ns.listen({port:o,host:s})}};window.Socket=e;window.Server=t})();function HttpServer(){}HttpServer.prototype.listen=function(e,t){this.socket=new Server;this.requestCallback=t;this.socket.listen(e,this.onSocket.bind(this))};HttpServer.prototype.onSocket=function(e){new HttpRequest(this,e,this.requestCallback)};HttpServer.prototype.destroy=function(){this.socket.destroy()};function HttpResponse(e){this.request=e;this.statusLine="HTTP/1.1 200 OK";this.headers={Date:(new Date).toUTCString()}}HttpResponse.prototype.write=function(e,t){if(e.constructor.name==Object.prototype.constructor.name){e=JSON.stringify(e)}if(e.constructor.name==String.prototype.constructor.name){e=str2ab(e)}if(!this.hasWritten){this.hasWritten=true;if(!this.headers["Content-Length"]){this.headers["Content-Length"]=e.byteLength}var n=[this.statusLine];for(var i in this.headers){n.push(i+": "+this.headers[i])}var r=n.join("\r\n")+"\r\n\r\n";this.request.socket.write(str2ab(r),function(){this.write(e,t)}.bind(this));return}this.request.socket.write(e,t)};HttpResponse.prototype.end=function(){this.request.server.onSocket(this.request.socket);this.request.socket=null};function HttpRequest(e,t,n){this.server=e;this.socket=t;this.headers={};this.parseRequest(function(){n(this,new HttpResponse(this))}.bind(this))}HttpRequest.prototype.parseRequest=function(e){var t=function(){readLine(this.socket,function(n){n=n.trim();if(!n.length){var i=this.headers["content-length"];if(i){i=Number.parseInt(i);this.socket.read(i,function(t){this.body=t;if(this.headers["content-type"]==="application/json"){this.body=JSON.parse(ab2str(this.body))}e()}.bind(this));return}e();return}if(!this.statusLine){this.statusLine=n;var r=n.split(" ");if(r.length>2){r=r[1].split("?");this.path=r[0];if(r.length>1)this.query=r[1]}}else{var r=n.split(":",2);if(r.length==2){this.headers[r[0].toLowerCase()]=r[1].trim()}}t()}.bind(this))}.bind(this);t()};(function(){var e;var t;function n(n){if(e){if(n){t=new Controller(e.contentWindow,true);n(e)}return}chrome.app.window.create("window.html",{bounds:{width:1280,height:720}},function(i){e=i;e.onClosed.addListener(function(){e=null;t=null});e.contentWindow.waiter=function(){if(n){t=new Controller(e.contentWindow,true);n(e)}};if(true||navigator.userAgent.indexOf("CrOS")==-1){return}chrome.system.network.getNetworkInterfaces(function(t){for(var n in t){n=t[n];if(n.address.indexOf(".")==-1){continue}var i="http://zxing.org/w/chart?cht=qr&chs=512x512&chld=L&choe=UTF-8&chl=";var r=encodeURIComponent("http://www.clockworkmod.com/allcast/discover?id="+n.address+"&ip="+n.address);var o=new XMLHttpRequest;o.open("GET",i+r,true);o.responseType="blob";o.onload=function(t){$(e.contentWindow.document).find("#qrcode").attr("src",e.contentWindow.URL.createObjectURL(this.response))};o.send();break}})})}chrome.app.runtime.onLaunched.addListener(function(){n()});function i(){if(!t){return null}return t.getVideoElement()}var r={"/":function(e,t){t.write("hello world",function(){t.end()})},"/api/v1/info":function(e,t){t.write({width:1280,height:960,mirror:"webrtc",subtitles:"text/vtt",proxyHeaders:true,hls:false,upsell:true},function(){t.end()})},"/api/v1/play":function(e,i){i.write({},function(){i.end()});n(function(){t.play(e.body)})},"/api/v1/launch":function(e,t){t.write({},function(){t.end()});n()},"/api/v1/stop":function(e,n){n.write({},function(){n.end()});if(t){t.stop()}},"/api/v1/die":function(e,n){n.write({},function(){n.end()});if(t){t.stop()}},"/api/v1/seek":function(e,n){n.write({},function(){n.end()});if(t){t.seek(e.body.position)}},"/api/v1/status":function(e,t){var n={stopped:true,duration:-1,position:-1,paused:false,captions:false};var r=i();n.captions=r!=null&&$(r).find("track").length>0;if(r){n.stopped=r.ended;n.paused=r.paused;if(Number.isFinite(r.duration)){n.duration=Math.round(r.duration*1e3)}if(r.currentTime){n.position=Math.round(r.currentTime*1e3)}}t.write(n,function(){t.end()})},"/api/v1/pause":function(e,n){n.write({},function(){n.end()});if(t){t.pause()}},"/api/v1/resume":function(e,n){n.write({},function(){n.end()});if(t){t.resume()}},"/api/v1/captions":function(e,n){n.write({},function(){n.end()});if(t){t.toggleCaptions()}},"/api/v1/webrtc":function(e,i){i.write({},function(){i.end()});n(function(n){t.webrtc(e.body.sessionUrl)})},"/api/v1/audio":function(e,t){var n=e.socket;n.onClose=function(e){n.destroy();console.log(e)};var i=Number.parseInt(e.headers["x-sample-rate"]);var r=2;t.statusLine="HTTP/1.1 101 Switching Protocols";var o=0;var s=new AudioContext;var a=function(e){console.log(n.pending.length);var t=e.subarray(8);var a=new DataView(t.buffer,t.byteOffset,t.byteLength);var u=t.byteLength/r;var d=s.createBufferSource();var f=s.createBuffer(r,u,i*2);var h=[];for(var l=0;l<r;l++){h.push(f.getChannelData(l))}for(var l=0;l<u;l++){var p=a.getInt16(l*2,true);p=p/65535;var v=Math.floor(l/r)*2;var g=h[l%r];g[v]=p;g[v+1]=p}d.buffer=f;d.connect(s.destination);if(o==0)o=s.currentTime;d.start(o);o+=f.duration;n.read(4,c)};var c=function(e){if(e.byteLength!=4){throw new Error("WTF")}var t=new DataView(e.buffer,e.byteOffset,4);var i=t.getInt32(0,true);n.read(i,a)};t.write({},function(){});n.read(4,c)},"/api/v1/h264":function(i,r){var o=i.socket;var s=false;var a=(new Date).getTime();if(s){$(e.contentWindow.document).find(".watermark").show()}var c=0;o.onClose=function(e){o.destroy();t.stop()};r.statusLine="HTTP/1.1 101 Switching Protocols";var u;var d=function(e){var t=e.subarray(8);u.decode(t,0,true);o.read(4,f)};var f=function(e){if(e.byteLength!=4){throw new Error("WTF")}var t=new DataView(e.buffer,e.byteOffset,4);var n=t.getInt32(0,true);o.read(n,d)};r.write({},function(){});n(function(e){u=t.video_decode(1280,720);u.onReady=function(){o.read(4,f)}})}};var o={404:"Not Found",416:"Range Request Not Satisfiable"};function s(e){e.error=function(e){this.statusLine="HTTP/1.1 "+e+" "+o[e];this.write("not found",function(){this.end()}.bind(this))}.bind(e)}var a=53515;var c=new HttpServer;c.listen(a,function(e,t){s(t);var n=r[decodeURIComponent(e.path)];if(!n){t.error(404);return}n(e,t)});chrome.sockets.udp.onReceive.addListener(function(e){chrome.system.network.getNetworkInterfaces(function(t){for(var n in t){n=t[n];if(n.address.indexOf(".")==-1){continue}var i={port:a,name:"Chrome @ "+n.address,id:n.address,width:1280,height:960,mirror:"h264",audio:"pcm",subtitles:"text/vtt",proxyHeaders:true,hls:false,upsell:true};var r=str2ab(JSON.stringify(i));chrome.sockets.udp.send(e.socketId,r,e.remoteAddress,e.remotePort,function(e){});break}})});chrome.sockets.udp.create(function(e){chrome.sockets.udp.bind(e.socketId,"0.0.0.0",a,function(e){})})})();var pcConfig={iceServers:[{url:"stun:stun.l.google.com:19302"}]};var pcConstraints={optional:[]};var iceCandidates=[];var pc;function connectWebRTCSession(e,t){if(pc){pc.close();pc=null}pc=new webkitRTCPeerConnection(pcConfig,pcConstraints);pc.onaddstream=function(e){t.src=URL.createObjectURL(e.stream)};pc.onicecandidate=function(e){if(e.candidate){console.log(e.candidate);iceCandidates.push({candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex})}};$.get(e,function(t){console.log(t);var n={type:"offer",sdp:t.sdp};pc.setRemoteDescription(new RTCSessionDescription(n),function(){for(var n in t.ice){var i=t.ice[n];var r=new RTCIceCandidate(i);try{console.log(r);pc.addIceCandidate(r)}catch(o){console.log(o)}}pc.createAnswer(function(t){pc.setLocalDescription(t);function n(){$.post(e,{sdp:t.sdp,ice:JSON.stringify(iceCandidates)},function(e){console.log(e)})}setTimeout(n,1e3)},function(e){console.log(e)})},function(e){console.log(e)})})}
